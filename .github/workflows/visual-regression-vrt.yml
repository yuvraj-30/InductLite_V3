name: Visual Regression (VRT)

on:
  workflow_dispatch:
    inputs:

    inputs:
      start_vrt:
        description: "If true, start docker-compose.vrt.yml on the runner before tests (default: false)"
        required: false
        default: "false"

jobs:
  visual-regression:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: "24"
          cache: "npm"


      - name: Cache Next and Playwright artifacts
        uses: actions/cache@v4
        with:
          path: |
            apps/web/.next/cache
            ~/.cache/ms-playwright
          key: ${{ runner.os }}-vrt-cache-${{ hashFiles('package-lock.json', 'apps/web/next.config.*', 'apps/web/playwright.config.ts', 'apps/web/package.json') }}
          restore-keys: |
            ${{ runner.os }}-vrt-cache-

      - name: Install deps (workspace)
        run: npm ci

      - name: Install Playwright browsers
        run: (cd apps/web && npx playwright install --with-deps chromium)

      - name: Optionally start VRT on runner
        if: ${{ github.event.inputs.start_vrt == 'true' }}
        run: |
          echo "Starting VRT compose on runner..."
          npm run vrt:up
          # Wait for API to be reachable
          for i in {1..30}; do
            if curl -sSf http://localhost:3000/health >/dev/null 2>&1; then
              echo "VRT API is up"
              break
            fi
            sleep 2
          done

      - name: Check for VRT secrets
        id: check
        run: |
          if [ -n "${{ secrets.VRT_API_KEY }}" ] && [ -n "${{ secrets.VRT_API_URL }}" ]; then
            echo "has_secrets=true" >> $GITHUB_OUTPUT
          else
            echo "has_secrets=false" >> $GITHUB_OUTPUT
          fi

      - name: Run visual tests and upload to VRT
        if: ${{ steps.check.outputs.has_secrets == 'true' }}
        env:
          VRT_API_KEY: ${{ secrets.VRT_API_KEY }}
          VRT_API_URL: ${{ secrets.VRT_API_URL }}
          VRT_ENABLED: "1"
        run: npm run -w apps/web test:visual

      - name: Skip visual upload
        if: ${{ steps.check.outputs.has_secrets == 'false' }}
        run: |
          echo "VRT secrets not set. Skipping VRT upload step. To run uploads, add VRT_API_KEY and VRT_API_URL to repo secrets."

      - name: Stop VRT on runner
        if: ${{ github.event.inputs.start_vrt == 'true' }}
        run: npm run vrt:down


      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: vrt-playwright-report
          path: apps/web/playwright-report/
          retention-days: 7
