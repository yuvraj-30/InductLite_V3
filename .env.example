# =============================================================================
# InductLite Environment Configuration
# =============================================================================
# Copy this file to .env.local for development
# For production, set these in your deployment platform's environment variables
# =============================================================================

# -----------------------------------------------------------------------------
# DATABASE (Required)
# -----------------------------------------------------------------------------
# For Neon deployments: prefer the Neon pooler endpoint (port 6543) for runtime connections.
# You can set `DATABASE_URL` to `NEON_POOLER_URL` in your deployment platform.
DATABASE_URL=postgresql://inductlite:inductlite_dev_password@localhost:5432/inductlite?schema=public
# Direct connection string for migrations (Neon direct endpoint in production)
DATABASE_DIRECT_URL=postgresql://inductlite:inductlite_dev_password@localhost:5432/inductlite?schema=public
# Optional: Neon pooler endpoint (port 6543) example
NEON_POOLER_URL=postgresql://inductlite:inductlite_dev_password@localhost:6543/inductlite?schema=public

# -----------------------------------------------------------------------------
# SECURITY - Session & Auth (Required)
# -----------------------------------------------------------------------------
# Session encryption key - MUST be at least 32 characters
# Generate with: openssl rand -base64 32
SESSION_SECRET=dev-secret-change-in-production-min-32-chars

# Optional: previous secrets for rotation (comma-separated)
# SESSION_SECRET_PREVIOUS=

# Optional: MFA encryption key (base64 32-byte)
# MFA_ENCRYPTION_KEY=

# Data encryption key for sensitive fields at rest (minimum 32 chars)
DATA_ENCRYPTION_KEY=dev-data-encryption-key-change-in-production

# Optional: separate secret for sign-out tokens (falls back to SESSION_SECRET)
# SIGN_OUT_TOKEN_SECRET=

# Admin password for initial seed (change in production, use strong password)
ADMIN_PASSWORD=Admin123!

# Trust proxy headers (set to 1 behind a reverse proxy like nginx/cloudflare)
TRUST_PROXY=0

# Cron security (shared secret + optional IP allowlist)
CRON_SECRET=dev-cron-secret-change-in-production
# CRON_ALLOWED_IPS=203.0.113.10/32,198.51.100.0/24
# CRON_ALLOW_GITHUB_ACTIONS=1
# CRON_ALLOW_PRIVATE_IPS=0

# Contractor magic links
MAGIC_LINK_SECRET=dev-magic-link-secret-change-in-production

# -----------------------------------------------------------------------------
# RATE LIMITING (Optional - Upstash Redis)
# -----------------------------------------------------------------------------
# If not set, the app falls back to in-memory rate limiting (not cluster-safe).
# For production with multiple instances, configure Upstash Redis.
UPSTASH_REDIS_REST_URL=
UPSTASH_REDIS_REST_TOKEN=

# -----------------------------------------------------------------------------
# FILE STORAGE (Required for production)
# -----------------------------------------------------------------------------
# Storage mode: 'local' (dev only) or 's3' (production)
STORAGE_MODE=local

# S3-compatible storage configuration (required when STORAGE_MODE=s3)
S3_BUCKET=
S3_REGION=ap-southeast-2
S3_ACCESS_KEY_ID=
S3_SECRET_ACCESS_KEY=
# Optional: custom S3 endpoint for S3-compatible services (e.g., Cloudflare R2)
S3_ENDPOINT=

# -----------------------------------------------------------------------------
# APPLICATION
# -----------------------------------------------------------------------------
NODE_ENV=development

# Public-facing app URL (must be HTTPS in production)
NEXT_PUBLIC_APP_URL=http://localhost:3000

# Logging level: trace, debug, info, warn, error, fatal
LOG_LEVEL=debug

# Email (Resend)
RESEND_API_KEY=
RESEND_FROM=no-reply@inductlite.co.nz

# -----------------------------------------------------------------------------
# FEATURE FLAGS & GUARDRAILS
# -----------------------------------------------------------------------------
# Kill switches for critical features
FEATURE_EXPORTS_ENABLED=true
FEATURE_UPLOADS_ENABLED=true
FEATURE_PUBLIC_SIGNIN_ENABLED=true
FEATURE_VISUAL_REGRESSION_ENABLED=false

# Environment budget tier and compute counters
ENV_BUDGET_TIER=MVP
MAX_MONTHLY_COMPUTE_INVOCATIONS=1200000
MAX_MONTHLY_COMPUTE_RUNTIME_MINUTES=2500

# Export limits (per ARCHITECTURE_GUARDRAILS.md)
MAX_EXPORT_ROWS=50000
MAX_EXPORT_BYTES=104857600
MAX_EXPORT_BYTES_GLOBAL_PER_DAY=2147483648
MAX_EXPORT_DOWNLOAD_BYTES_PER_COMPANY_PER_DAY=536870912
MAX_EXPORT_DOWNLOAD_BYTES_GLOBAL_PER_DAY=5368709120
MAX_EXPORTS_PER_COMPANY_PER_DAY=5
MAX_EXPORT_RUNTIME_SECONDS=120
MAX_CONCURRENT_EXPORTS_GLOBAL=1
MAX_CONCURRENT_EXPORTS_PER_COMPANY=1
EXPORT_OFFPEAK_ONLY=false
EXPORT_OFFPEAK_AUTO_ENABLE_THRESHOLD_PERCENT=20
EXPORT_OFFPEAK_AUTO_ENABLE_QUEUE_DELAY_SECONDS=60
EXPORT_OFFPEAK_AUTO_ENABLE_DAYS=7

# Upload limits
MAX_UPLOAD_MB=5
UPLOAD_ALLOWED_MIME=application/pdf,image/jpeg,image/png
UPLOAD_ALLOWED_EXTENSIONS=pdf,jpg,jpeg,png
UPLOAD_REQUIRE_SERVER_MIME_SNIFF=true
UPLOAD_REQUIRE_MAGIC_BYTES=true

# Retention (days)
FILES_RETENTION_DAYS=90
EXPORTS_RETENTION_DAYS=30
AUDIT_RETENTION_DAYS=90
LOG_RETENTION_DAYS=14

# Per-tenant hard quotas
MAX_TENANT_STORAGE_GB=5
MAX_TENANT_EGRESS_GB_PER_MONTH=20
MAX_TENANT_JOB_MINUTES_PER_MONTH=300
MAX_TENANT_COMPUTE_INVOCATIONS_PER_MONTH=250000

# SMS (disabled by default - paid feature)
SMS_ENABLED=false
MAX_MESSAGES_PER_COMPANY_PER_MONTH=0
MAX_EMAILS_PER_COMPANY_PER_MONTH=500
MAX_EMAILS_GLOBAL_PER_DAY=2000

# Public/admin abuse controls
RL_PUBLIC_SLUG_PER_IP_PER_MIN=30
RL_SIGNIN_PER_IP_PER_MIN=30
RL_SIGNIN_PER_SITE_PER_MIN=200
RL_SIGNOUT_PER_IP_PER_MIN=30
RL_ADMIN_PER_USER_PER_MIN=60
RL_ADMIN_PER_IP_PER_MIN=120
RL_ADMIN_MUTATION_PER_COMPANY_PER_MIN=60

# CSP (Content-Security-Policy)
# Enforced CSP is applied via `apps/web/src/middleware.ts`.
# Optional: enable a stricter Report-Only policy + violation reporting.
CSP_REPORT_ONLY=0
# Relative path recommended; middleware will convert to absolute URL per-request
CSP_REPORT_ENDPOINT=/api/csp-report
# Rate-limit CSP report ingestion (per client key per minute)
CSP_REPORT_RL_PER_MIN=60

# Optional: strict Report-Only allowlists (space-separated directive values)
# Use these to tighten safely in Report-Only before promoting into the enforced policy.
# Examples:
# CSP_RO_CONNECT_SRC="'self' https://api.upstash.com https://*.upstash.io wss://*.upstash.io https://storage.yourdomain.com"
# CSP_RO_IMG_SRC="'self' data: blob: https://storage.yourdomain.com"
# CSP_RO_FONT_SRC="'self' data:"
# CSP_RO_FRAME_SRC="'self'"
CSP_RO_CONNECT_SRC=
CSP_RO_IMG_SRC=
CSP_RO_FONT_SRC=
CSP_RO_FRAME_SRC=

# Optional: Visual Regression Tracker (self-hosted)
# To run VRT locally in Docker, see `apps/web/docs/VISUAL_REGRESSION.md`
# Enable VRT uploads during e2e runs by setting:
# VRT_ENABLED=1
# VRT_API_URL=http://localhost:8080
# VRT_API_KEY=your-vrt-api-key
# Note: do NOT commit real secrets. Add them to your local env or CI secrets.
